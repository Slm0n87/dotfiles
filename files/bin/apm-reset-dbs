#!/bin/sh

# You can override the apm_bundle location as an environment variable, in a
# config file, or by editing this file. You can also override the conffile
# location.

: ${conffile:=$HOME/.apm_updaterc}

[ -f $conffile ] && . $conffile

: ${apm_bundle:=~/code/apm_bundle}

show_help() {
  echo "Usage: $(basename $0) [OPTIONS]"
  echo
  echo "OPTIONS:"
  echo "  -h  Show this help"
}

while getopts 'Gh' opt; do
  case "$opt" in
    h)
      show_help
      exit 0
      ;;
  esac
done

cd $apm_bundle

(
  for dir in $apm_bundle/apps/* $apm_bundle/apps/property/engines/* ; do
    (
      set -x
      cd $dir
      [ -f Gemfile ] && bundle
      [ -f config/database.yml ] && (
        for env in test development; do
          (
            RAILS_ENV=$env rake db:drop db:create db:migrate db:fixtures:load
          ) &
        done
      )
    ) &
  done
  wait
)
