#!/bin/bash

# TODO
# - Allow configuring verbose/quiet?
# - Allow disabling parallelism?

function download() {
  local url=$1; shift
  axel -n5 "$url" 1>&5 2>&6
}

function file_attached_to_stdin() {
  ! test -t 0
}

function gather_urls() {
  local urls=($@)
  if file_attached_to_stdin; then
    while read -r url; do
      urls=("${urls[@]}" "$url")
    done
  fi
  echo "${urls[@]}"
}

function download_all() {
  local urls=($@)
  for url in "${urls[@]}"; do
    download "$url" &
  done
  wait
}

function set_up_io {
  exec 3>&1         # stdout from this script
  exec 4>&2         # stderr from this script
  exec 5<>/dev/null # stdout from scripts run by this script, e.g. axel
  exec 6>&2         # stderr from scripts run by this script, e.g. axel
}

function main() {
  set_up_io
  download_all "$(gather_urls "$@")"
}

main "$@"
