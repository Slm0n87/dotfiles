#!/usr/bin/env ruby

begin
  require 'trollop'
rescue LoadError
  warn <<STR
Trollop isn't installed. We need that for argument parsing. Run

  gem install trollop
STR
  exit false
end

module ScriptStart

  VERSION = '0.0'.freeze

  APM_BUNDLE_PATH  = ENV['APM_BUNDLE'].freeze
  DEFAULT_APPS     = ['property'.freeze].freeze
  DEFAULT_FORCE    = false

  def self.run(opts)
    exit_if_bad_environment
    opts.apps.each { |app| Command.new(app, opts.force).run }
  end

  def self.exit_if_bad_environment
    if APM_BUNDLE_PATH.nil?
      warn <<STR
You need to export APM_BUNDLE to match your apm_bundle repo location.
e.g. Add this to your ~/.bash_profile

export APM_BUNDLE=~/src/apm_bundle
STR
      exit false
    end
  end

  private

  class Command

    COMMAND_TEMPLATE = "cd %{app_path} && script/start %{force}"

    def initialize(app, force)
      @app   = app
      @force = force
    end

    def run
      puts "Running `#{command}'"
      system command
    end

    private

    def command
      @command ||= COMMAND_TEMPLATE % {app_path: app_path(@app), force: force}
    end

    def app_path(app)
      "#{APM_BUNDLE_PATH}/apps/#{app}"
    end

    def force
      '--force' if @force
    end
  end
end

opts = Trollop::options do
  version ScriptStart::VERSION
  opt :apps, 'A list of apps to start delimited by spaces', default: ScriptStart::DEFAULT_APPS
  opt :force, 'Whether to use --force with script/start (applies to all)', default: ScriptStart::DEFAULT_FORCE
end

ScriptStart.run opts
