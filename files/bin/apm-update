#!/bin/sh

# You can override the apm_bundle location as an environment variable, in a
# config file, or by editing this file. You can also override the conffile
# location.

: ${conffile:=$HOME/.apm-updaterc}

[ -f $conffile ] && . $conffile

: ${apm_bundle:=~/code/apm_bundle}

git_command="git pull --rebase origin master"

show_help() {
  echo "Usage: $(basename $0) [OPTIONS]"
  echo
  echo "OPTIONS:"
  echo "  -G  Don't do '$git_command'"
  echo "  -h  Show this help"
}

while getopts 'Gh' opt; do
  case "$opt" in
    h)
      show_help
      exit 0
      ;;
    G)
      no_git=1
    ;;
  esac
done

cd $apm_bundle
[ "$no_git" = 1 ] || $git_command

(
  for dir in $apm_bundle/apps/* $apm_bundle/apps/property/engines/* ; do
    (
      set -x
      cd $dir
      [ -f Gemfile ] && bundle
      [ -f config/database.yml ] && (
        for env in test development; do
          (
            RAILS_ENV=$env rake db:migrate
          ) &
        done
      )
    ) &
  done
  wait
)
